---
{"dg-publish":true,"permalink":"/å‰ç«¯å…«è‚¡/Javascript/Promise/"}
---

## å¯¹Promiseçš„ç†è§£

> [!NOTE]
> Promise å¯¹è±¡æ˜¯å¼‚æ­¥ç¼–ç¨‹çš„ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œæœ€æ—©ç”±ç¤¾åŒºæå‡ºã€‚Promise æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œæ¥æ”¶ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ª Promise å®ä¾‹ã€‚ä¸€ä¸ª Promise å®ä¾‹æœ‰ä¸‰ç§çŠ¶æ€ï¼Œåˆ†åˆ«æ˜¯pendingã€resolved å’Œ rejectedï¼Œåˆ†åˆ«ä»£è¡¨äº†è¿›è¡Œä¸­ã€å·²æˆåŠŸå’Œå·²å¤±è´¥ã€‚å®ä¾‹çš„çŠ¶æ€åªèƒ½ç”± pending è½¬å˜ resolved æˆ–è€…rejected çŠ¶æ€ï¼Œå¹¶ä¸”çŠ¶æ€ä¸€ç»æ”¹å˜ï¼Œå°±å‡å›ºäº†ï¼Œæ— æ³•å†è¢«æ”¹å˜äº†ã€‚

Promiseæ˜¯å¼‚æ­¥ç¼–ç¨‹çš„ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œå®ƒæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¯ä»¥è·å–å¼‚æ­¥æ“ä½œçš„æ¶ˆæ¯ï¼Œä»–çš„å‡ºç°å¤§å¤§æ”¹å–„äº†å¼‚æ­¥ç¼–ç¨‹çš„å›°å¢ƒï¼Œé¿å…äº†åœ°ç‹±å›è°ƒï¼Œå®ƒæ¯”ä¼ ç»Ÿçš„è§£å†³æ–¹æ¡ˆå›è°ƒå‡½æ•°å’Œäº‹ä»¶æ›´åˆç†å’Œæ›´å¼ºå¤§ã€‚

æ‰€è°“Promiseï¼Œç®€å•è¯´å°±æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œé‡Œé¢ä¿å­˜ç€æŸä¸ªæœªæ¥æ‰ä¼šç»“æŸçš„äº‹ä»¶ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼‰çš„ç»“æœã€‚ä»è¯­æ³•ä¸Šè¯´ï¼ŒPromise æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä»å®ƒå¯ä»¥è·å–å¼‚æ­¥æ“ä½œçš„æ¶ˆæ¯ã€‚Promise æä¾›ç»Ÿä¸€çš„ APIï¼Œå„ç§å¼‚æ­¥æ“ä½œéƒ½å¯ä»¥ç”¨åŒæ ·çš„æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚

ï¼ˆ1ï¼‰Promiseçš„å®ä¾‹æœ‰**ä¸‰ä¸ªçŠ¶æ€**:  

- Pendingï¼ˆè¿›è¡Œä¸­ï¼‰
- Resolvedï¼ˆå·²å®Œæˆï¼‰
- Rejectedï¼ˆå·²æ‹’ç»ï¼‰

å½“æŠŠä¸€ä»¶äº‹æƒ…äº¤ç»™promiseæ—¶ï¼Œå®ƒçš„çŠ¶æ€å°±æ˜¯Pendingï¼Œä»»åŠ¡å®Œæˆäº†çŠ¶æ€å°±å˜æˆäº†Resolvedã€æ²¡æœ‰å®Œæˆå¤±è´¥äº†å°±å˜æˆäº†Rejectedã€‚  

ï¼ˆ2ï¼‰Promiseçš„å®ä¾‹æœ‰**ä¸¤ä¸ªè¿‡ç¨‹**ï¼š  

- pendingÂ ->Â fulfilledÂ :Â Resolvedï¼ˆå·²å®Œæˆï¼‰
- pendingÂ ->Â rejectedï¼šRejectedï¼ˆå·²æ‹’ç»ï¼‰

æ³¨æ„ï¼šä¸€æ—¦ä»è¿›è¡ŒçŠ¶æ€å˜æˆä¸ºå…¶ä»–çŠ¶æ€å°±æ°¸è¿œä¸èƒ½æ›´æ”¹çŠ¶æ€äº†ã€‚  

## **Promiseçš„ç‰¹ç‚¹ï¼š**  

- å¯¹è±¡çš„çŠ¶æ€ä¸å—å¤–ç•Œå½±å“ã€‚promiseå¯¹è±¡ä»£è¡¨ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œæœ‰ä¸‰ç§çŠ¶æ€ï¼Œâ€‹`pending`â€‹ï¼ˆè¿›è¡Œä¸­ï¼‰ã€â€‹`fulfilled`â€‹ï¼ˆå·²æˆåŠŸï¼‰ã€â€‹`rejected`â€‹ï¼ˆå·²å¤±è´¥ï¼‰ã€‚åªæœ‰å¼‚æ­¥æ“ä½œçš„ç»“æœï¼Œå¯ä»¥å†³å®šå½“å‰æ˜¯å“ªä¸€ç§çŠ¶æ€ï¼Œä»»ä½•å…¶ä»–æ“ä½œéƒ½æ— æ³•æ”¹å˜è¿™ä¸ªçŠ¶æ€ï¼Œè¿™ä¹Ÿæ˜¯promiseè¿™ä¸ªåå­—çš„ç”±æ¥â€”â€”â€œ**æ‰¿è¯º**â€ï¼›
- ä¸€æ—¦çŠ¶æ€æ”¹å˜å°±ä¸ä¼šå†å˜ï¼Œä»»ä½•æ—¶å€™éƒ½å¯ä»¥å¾—åˆ°è¿™ä¸ªç»“æœã€‚promiseå¯¹è±¡çš„çŠ¶æ€æ”¹å˜ï¼Œåªæœ‰ä¸¤ç§å¯èƒ½ï¼šä»Â â€‹`pending`â€‹å˜ä¸ºÂ â€‹`fulfilled`â€‹ï¼Œä»Â â€‹`pending`â€‹å˜ä¸ºÂ â€‹`rejected`â€‹ã€‚è¿™æ—¶å°±ç§°ä¸ºÂ â€‹`resolved`â€‹ï¼ˆå·²å®šå‹ï¼‰ã€‚å¦‚æœæ”¹å˜å·²ç»å‘ç”Ÿäº†ï¼Œä½ å†å¯¹promiseå¯¹è±¡æ·»åŠ å›è°ƒå‡½æ•°ï¼Œä¹Ÿä¼šç«‹å³å¾—åˆ°è¿™ä¸ªç»“æœã€‚è¿™ä¸äº‹ä»¶ï¼ˆeventï¼‰å®Œå…¨ä¸åŒï¼Œäº‹ä»¶çš„ç‰¹ç‚¹æ˜¯ï¼šå¦‚æœä½ é”™è¿‡äº†å®ƒï¼Œå†å»ç›‘å¬æ˜¯å¾—ä¸åˆ°ç»“æœçš„ã€‚

**Promiseçš„ç¼ºç‚¹ï¼š**  

- æ— æ³•å–æ¶ˆPromiseï¼Œä¸€æ—¦æ–°å»ºå®ƒå°±ä¼šç«‹å³æ‰§è¡Œï¼Œæ— æ³•ä¸­é€”å–æ¶ˆã€‚
- å¦‚æœä¸è®¾ç½®å›è°ƒå‡½æ•°ï¼ŒPromiseå†…éƒ¨æŠ›å‡ºçš„é”™è¯¯ï¼Œä¸ä¼šååº”åˆ°å¤–éƒ¨ã€‚
- å½“å¤„äºpendingçŠ¶æ€æ—¶ï¼Œæ— æ³•å¾—çŸ¥ç›®å‰è¿›å±•åˆ°å“ªä¸€ä¸ªé˜¶æ®µï¼ˆåˆšåˆšå¼€å§‹è¿˜æ˜¯å³å°†å®Œæˆï¼‰ã€‚

çŠ¶æ€çš„æ”¹å˜æ˜¯é€šè¿‡ resolve() å’Œ reject() å‡½æ•°æ¥å®ç°çš„ï¼Œå¯ä»¥åœ¨å¼‚æ­¥æ“ä½œç»“æŸåè°ƒç”¨è¿™ä¸¤ä¸ªå‡½æ•°æ”¹å˜ Promise å®ä¾‹çš„çŠ¶æ€ï¼Œå®ƒçš„åŸå‹ä¸Šå®šä¹‰äº†ä¸€ä¸ª then æ–¹æ³•ï¼Œä½¿ç”¨è¿™ä¸ª then æ–¹æ³•å¯ä»¥ä¸ºä¸¤ä¸ªçŠ¶æ€çš„æ”¹å˜æ³¨å†Œå›è°ƒå‡½æ•°ã€‚è¿™ä¸ªå›è°ƒå‡½æ•°å±äºå¾®ä»»åŠ¡ï¼Œä¼šåœ¨æœ¬è½®äº‹ä»¶å¾ªç¯çš„æœ«å°¾æ‰§è¡Œã€‚

**æ³¨æ„ï¼š**åœ¨æ„é€ Â `Promise`Â çš„æ—¶å€™ï¼Œæ„é€ å‡½æ•°å†…éƒ¨çš„ä»£ç æ˜¯ç«‹å³æ‰§è¡Œçš„  

#### promiseå’Œsettimeoutçš„ç›¸åŒç‚¹å’Œä¸åŒ

åœ¨é¢è¯•ä¸­è¢«é—®åˆ° **Promise å’Œ setTimeout çš„ç›¸åŒç‚¹ä¸ä¸åŒç‚¹**ï¼Œå¯ä»¥ä»**ç”¨é€”ã€å¼‚æ­¥æœºåˆ¶ã€æ‰§è¡Œæ—¶æœºã€ä¼˜å…ˆçº§**ç­‰æ–¹é¢æ¥å›ç­”ï¼Œä½“ç°ä½ å¯¹ JavaScript äº‹ä»¶å¾ªç¯çš„ç†è§£ã€‚ä»¥ä¸‹æ˜¯ä¸€ä»½é«˜è´¨é‡ã€æ¡ç†æ¸…æ™°çš„å£å¤´å›ç­”æ¨¡æ¿ï¼š

---

### âœ… é¢è¯•å£å¤´å›ç­”æ¨¡æ¿ï¼š

> Promise å’Œ setTimeout éƒ½æ˜¯ç”¨æ¥å¤„ç†**å¼‚æ­¥ä»»åŠ¡**çš„æœºåˆ¶ï¼Œä½†å®ƒä»¬çš„æœ¬è´¨å’Œæ‰§è¡Œæ—¶æœºä¸åŒã€‚å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥æ¯”è¾ƒï¼š

#### âœ… ç›¸åŒç‚¹ï¼š

1. **éƒ½æ˜¯å¼‚æ­¥æ‰§è¡Œ**
    
    - å®ƒä»¬ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼Œä»»åŠ¡ä¼šè¢«æ¨è¿Ÿåˆ°å½“å‰æ‰§è¡Œæ ˆæ¸…ç©ºä¹‹åå†æ‰§è¡Œã€‚
        
2. **éƒ½å¯ä»¥é€šè¿‡å›è°ƒæ¥å¤„ç†ç»“æœ**
    
    - `setTimeout(fn, 0)` ç”¨å›è°ƒå‡½æ•°å¤„ç†ï¼›
        
    - `Promise.then()` åˆ™ç”¨é“¾å¼å†™æ³•å¤„ç†å¼‚æ­¥ç»“æœã€‚
        

---

#### âŒ ä¸åŒç‚¹ï¼š

1. **æœ¬è´¨åŒºåˆ«ï¼š**
    
    - `setTimeout` æ˜¯ **åŸºäºå®šæ—¶å™¨çš„å®ä»»åŠ¡ï¼ˆmacro taskï¼‰**ï¼›
        
    - `Promise.then()` æ˜¯ **å¾®ä»»åŠ¡ï¼ˆmicro taskï¼‰**ï¼Œæ˜¯ ES6 å¼•å…¥çš„æ›´ç°ä»£ã€æ›´é«˜æ•ˆçš„å¼‚æ­¥æ–¹æ¡ˆã€‚
        
2. **æ‰§è¡Œæ—¶æœºä¸åŒï¼š**
    
    - å¾®ä»»åŠ¡ï¼ˆå¦‚ Promiseï¼‰ä¼šåœ¨**å½“å‰å®ä»»åŠ¡ç»“æŸåï¼Œç«‹å³æ‰§è¡Œ**ï¼›
        
    - å®ä»»åŠ¡ï¼ˆå¦‚ setTimeoutï¼‰åˆ™ä¼šåœ¨æ‰€æœ‰å¾®ä»»åŠ¡æ‰§è¡Œå®Œä¹‹åæ‰æ‰§è¡Œã€‚
        
    - æ‰€ä»¥ï¼š
        
        ```js
        Promise.resolve().then(() => console.log('promise'));
        setTimeout(() => console.log('timeout'), 0);
        // è¾“å‡ºé¡ºåºï¼š'promise' -> 'timeout'
        ```
        
3. **æ§åˆ¶ç²’åº¦ä¸åŒï¼š**
    
    - `setTimeout` åªèƒ½é€šè¿‡æ—¶é—´æ§åˆ¶å¼‚æ­¥é€»è¾‘ï¼Œä¸é€‚åˆé“¾å¼å¤æ‚å¼‚æ­¥åœºæ™¯ï¼›
        
    - `Promise` æ”¯æŒé“¾å¼è°ƒç”¨ã€é”™è¯¯æ•è·ï¼ˆ`.catch()`ï¼‰ï¼Œæ›´é€‚åˆç»„ç»‡å¤šä¸ªå¼‚æ­¥ä»»åŠ¡ã€‚
        
4. **ç”¨é€”ä¸åŒï¼š**
    
    - `setTimeout` æ›´åƒæ˜¯å®šæ—¶è°ƒåº¦ï¼›
        
    - `Promise` æ›´é€‚åˆå¤„ç†**å¼‚æ­¥é€»è¾‘æµç¨‹æ§åˆ¶**ï¼Œæ¯”å¦‚å¼‚æ­¥è¯·æ±‚ã€æ–‡ä»¶æ“ä½œç­‰ã€‚
        

---

### ğŸ¯ æ€»ç»“è¯­å¥ï¼š

> æ€»çš„æ¥è¯´ï¼Œ`Promise` æ˜¯ç°ä»£å¼‚æ­¥ç¼–ç¨‹çš„æ ¸å¿ƒï¼Œæä¾›æ›´å¼ºçš„è¯­ä¹‰å’Œæ§åˆ¶èƒ½åŠ›ï¼Œè€Œ `setTimeout` æ›´åå‘åŸºç¡€çš„æ—¶é—´æ§åˆ¶ã€‚å®ƒä»¬éƒ½å±äºäº‹ä»¶å¾ªç¯çš„ä¸€éƒ¨åˆ†ï¼Œä½† Promise å±äºå¾®ä»»åŠ¡ï¼Œä¼˜å…ˆçº§æ¯” setTimeout æ›´é«˜ã€‚

---

å¦‚æœä½ è¿˜éœ€è¦æˆ‘è¡¥å……ä¸€æ®µ**å¸¦è¾“å‡ºé¡ºåºçš„ç¤ºä¾‹ä»£ç  + å›¾ç¤ºè¯´æ˜äº‹ä»¶å¾ªç¯æ‰§è¡Œè¿‡ç¨‹**ï¼Œä¹Ÿå¯ä»¥å‘Šè¯‰æˆ‘ã€‚
### 4. Promiseçš„åŸºæœ¬ç”¨æ³•

#### ï¼ˆ1ï¼‰åˆ›å»ºPromiseå¯¹è±¡

Promiseå¯¹è±¡ä»£è¡¨ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œæœ‰ä¸‰ç§çŠ¶æ€ï¼špendingï¼ˆè¿›è¡Œä¸­ï¼‰ã€fulfilledï¼ˆå·²æˆåŠŸï¼‰å’Œrejectedï¼ˆå·²å¤±è´¥ï¼‰ã€‚  

Promiseæ„é€ å‡½æ•°æ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¯¥å‡½æ•°çš„ä¸¤ä¸ªå‚æ•°åˆ†åˆ«æ˜¯Â `resolve`å’ŒÂ `reject`ã€‚

``` js
const promise = new Promise(function(resolve, reject) {
  // ... some code
  if (/* å¼‚æ­¥æ“ä½œæˆåŠŸ */){
    resolve(value);
  } else {
    reject(error);
  }
});
```

**ä¸€èˆ¬æƒ…å†µä¸‹éƒ½ä¼šä½¿ç”¨**Â `new Promise()`**æ¥åˆ›å»ºpromiseå¯¹è±¡ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥ä½¿ç”¨**Â `promise.resolve`**å’Œ**Â `promise.reject`**è¿™ä¸¤ä¸ªæ–¹æ³•ï¼š**  

- Promise.resolve

`Promise.resolve(value)`çš„è¿”å›å€¼ä¹Ÿæ˜¯ä¸€ä¸ªpromiseå¯¹è±¡ï¼Œå¯ä»¥å¯¹è¿”å›å€¼è¿›è¡Œ.thenè°ƒç”¨ï¼Œä»£ç å¦‚ä¸‹ï¼š

``` js
Promise.resolve(11).then(function(value){
  console.log(value); // æ‰“å°å‡º11
});
```

`resolve(11)`ä»£ç ä¸­ï¼Œä¼šè®©promiseå¯¹è±¡è¿›å…¥ç¡®å®š(`resolve`çŠ¶æ€)ï¼Œå¹¶å°†å‚æ•°Â `11`ä¼ é€’ç»™åé¢çš„Â `then`æ‰€æŒ‡å®šçš„Â `onFulfilled`Â å‡½æ•°ï¼›  

åˆ›å»ºpromiseå¯¹è±¡å¯ä»¥ä½¿ç”¨Â `new Promise`çš„å½¢å¼åˆ›å»ºå¯¹è±¡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨Â `Promise.resolve(value)`çš„å½¢å¼åˆ›å»ºpromiseå¯¹è±¡ï¼›  

- Promise.reject

`Promise.reject`Â ä¹Ÿæ˜¯Â `new Promise`çš„å¿«æ·å½¢å¼ï¼Œä¹Ÿåˆ›å»ºä¸€ä¸ªpromiseå¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

``` js
Promise.reject(new Error(â€œæˆ‘é”™äº†ï¼Œè¯·åŸè°…ä¿ºï¼ï¼â€));
```

å°±æ˜¯ä¸‹é¢çš„ä»£ç new Promiseçš„ç®€å•å½¢å¼ï¼š

``` js
new Promise(function(resolve,reject){
   reject(new Error("æˆ‘é”™äº†ï¼Œè¯·åŸè°…ä¿ºï¼ï¼"));
});
```

ä¸‹é¢æ˜¯ä½¿ç”¨resolveæ–¹æ³•å’Œrejectæ–¹æ³•ï¼š

``` js 
function testPromise(ready) {
  return new Promise(function(resolve,reject){
    if(ready) {
      resolve("hello world");
    }else {
      reject("No thanks");
    }
  });
};
// æ–¹æ³•è°ƒç”¨
testPromise(true).then(function(msg){
  console.log(msg);
},function(error){
  console.log(error);
});
```

ä¸Šé¢çš„ä»£ç çš„å«ä¹‰æ˜¯ç»™Â `testPromise`æ–¹æ³•ä¼ é€’ä¸€ä¸ªå‚æ•°ï¼Œè¿”å›ä¸€ä¸ªpromiseå¯¹è±¡ï¼Œå¦‚æœä¸ºÂ `true`çš„è¯ï¼Œé‚£ä¹ˆè°ƒç”¨promiseå¯¹è±¡ä¸­çš„Â `resolve()`æ–¹æ³•ï¼Œå¹¶ä¸”æŠŠå…¶ä¸­çš„å‚æ•°ä¼ é€’ç»™åé¢çš„Â `then`ç¬¬ä¸€ä¸ªå‡½æ•°å†…ï¼Œå› æ­¤æ‰“å°å‡º â€œ`hello world`â€, å¦‚æœä¸ºÂ `false`çš„è¯ï¼Œä¼šè°ƒç”¨promiseå¯¹è±¡ä¸­çš„Â `reject()`æ–¹æ³•ï¼Œåˆ™ä¼šè¿›å…¥Â `then`çš„ç¬¬äºŒä¸ªå‡½æ•°å†…ï¼Œä¼šæ‰“å°Â `No thanks`ï¼›  

#### ï¼ˆ2ï¼‰Promiseæ–¹æ³•

Promiseæœ‰äº”ä¸ªå¸¸ç”¨çš„æ–¹æ³•ï¼šthen()ã€catch()ã€all()ã€race()ã€finallyã€‚ä¸‹é¢å°±æ¥çœ‹ä¸€ä¸‹è¿™äº›æ–¹æ³•ã€‚  

- then()

å½“Promiseæ‰§è¡Œçš„å†…å®¹ç¬¦åˆæˆåŠŸæ¡ä»¶æ—¶ï¼Œè°ƒç”¨Â `resolve`å‡½æ•°ï¼Œå¤±è´¥å°±è°ƒç”¨Â `reject`å‡½æ•°ã€‚Promiseåˆ›å»ºå®Œäº†ï¼Œé‚£è¯¥å¦‚ä½•è°ƒç”¨å‘¢ï¼Ÿ

``` js
promise.then(function(value) {
  // success
}, function(error) {
  // failure
});
```

`then`æ–¹æ³•å¯ä»¥æ¥å—ä¸¤ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ã€‚ç¬¬ä¸€ä¸ªå›è°ƒå‡½æ•°æ˜¯Promiseå¯¹è±¡çš„çŠ¶æ€å˜ä¸ºÂ `resolved`æ—¶è°ƒç”¨ï¼Œç¬¬äºŒä¸ªå›è°ƒå‡½æ•°æ˜¯Promiseå¯¹è±¡çš„çŠ¶æ€å˜ä¸ºÂ `rejected`æ—¶è°ƒç”¨ã€‚å…¶ä¸­ç¬¬äºŒä¸ªå‚æ•°å¯ä»¥çœç•¥ã€‚  

`then`æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªæ–°çš„Promiseå®ä¾‹ï¼ˆä¸æ˜¯åŸæ¥é‚£ä¸ªPromiseå®ä¾‹ï¼‰ã€‚å› æ­¤å¯ä»¥é‡‡ç”¨é“¾å¼å†™æ³•ï¼Œå³Â `then`æ–¹æ³•åé¢å†è°ƒç”¨å¦ä¸€ä¸ªthenæ–¹æ³•ã€‚  

å½“è¦å†™æœ‰é¡ºåºçš„å¼‚æ­¥äº‹ä»¶æ—¶ï¼Œéœ€è¦ä¸²è¡Œæ—¶ï¼Œå¯ä»¥è¿™æ ·å†™ï¼š

``` js
let promise = new Promise((resolve,reject)=>{
    ajax('first').success(function(res){
        resolve(res);
    })
})
promise.then(res=>{
    return new Promise((resovle,reject)=>{
        ajax('second').success(function(res){
            resolve(res)
        })
    })
}).then(res=>{
    return new Promise((resovle,reject)=>{
        ajax('second').success(function(res){
            resolve(res)
        })
    })
}).then(res=>{
  
})
```

é‚£å½“è¦å†™çš„äº‹ä»¶æ²¡æœ‰é¡ºåºæˆ–è€…å…³ç³»æ—¶ï¼Œè¿˜å¦‚ä½•å†™å‘¢ï¼Ÿå¯ä»¥ä½¿ç”¨Â `all`Â æ–¹æ³•æ¥è§£å†³ã€‚  

- catch()

Promiseå¯¹è±¡é™¤äº†æœ‰thenæ–¹æ³•ï¼Œè¿˜æœ‰ä¸€ä¸ªcatchæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç›¸å½“äºÂ `then`æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ï¼ŒæŒ‡å‘Â `reject`çš„å›è°ƒå‡½æ•°ã€‚ä¸è¿‡Â `catch`æ–¹æ³•è¿˜æœ‰ä¸€ä¸ªä½œç”¨ï¼Œå°±æ˜¯åœ¨æ‰§è¡ŒÂ `resolve`å›è°ƒå‡½æ•°æ—¶ï¼Œå¦‚æœå‡ºç°é”™è¯¯ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼Œä¸ä¼šåœæ­¢è¿è¡Œï¼Œè€Œæ˜¯è¿›å…¥Â `catch`æ–¹æ³•ä¸­ã€‚

``` js
p.then((data) => {
     console.log('resolved',data);
},(err) => {
     console.log('rejected',err);
     }
); 
p.then((data) => {
    console.log('resolved',data);
}).catch((err) => {
    console.log('rejected',err);
});
```

- all()

`all`æ–¹æ³•å¯ä»¥å®Œæˆå¹¶è¡Œä»»åŠ¡ï¼Œ å®ƒæ¥æ”¶ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„çš„æ¯ä¸€é¡¹éƒ½æ˜¯ä¸€ä¸ªÂ `promise`å¯¹è±¡ã€‚å½“æ•°ç»„ä¸­æ‰€æœ‰çš„Â `promise`çš„çŠ¶æ€éƒ½è¾¾åˆ°Â `resolved`çš„æ—¶å€™ï¼Œ`all`æ–¹æ³•çš„çŠ¶æ€å°±ä¼šå˜æˆÂ `resolved`ï¼Œå¦‚æœæœ‰ä¸€ä¸ªçŠ¶æ€å˜æˆäº†Â `rejected`ï¼Œé‚£ä¹ˆÂ `all`æ–¹æ³•çš„çŠ¶æ€å°±ä¼šå˜æˆÂ `rejected`ã€‚

``` js
javascript
let promise1 = new Promise((resolve,reject)=>{
    setTimeout(()=>{
       resolve(1);
    },2000)
});
let promise2 = new Promise((resolve,reject)=>{
    setTimeout(()=>{
       resolve(2);
    },1000)
});
let promise3 = new Promise((resolve,reject)=>{
    setTimeout(()=>{
       resolve(3);
    },3000)
});
Promise.all([promise1,promise2,promise3]).then(res=>{
    console.log(res);
    //ç»“æœä¸ºï¼š[1,2,3] 
})
function all(promises){
  return new Promise((resolve,reject) => {
    let lens = promises.length;
    let count = 0;
    let res = [];
    for(let i = 0; i < lens; i++){
      promises[i].then(val => {
        count++;
        res.push(val);
        if(count === lens){
          resolve(res)
        }
      }).catch(error => {
        reject(error)
      })
    }
  })
}
```

è°ƒç”¨Â `all`æ–¹æ³•æ—¶çš„ç»“æœæˆåŠŸçš„æ—¶å€™æ˜¯å›è°ƒå‡½æ•°çš„å‚æ•°ä¹Ÿæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè¿™ä¸ªæ•°ç»„æŒ‰é¡ºåºä¿å­˜ç€æ¯ä¸€ä¸ªpromiseå¯¹è±¡Â `resolve`æ‰§è¡Œæ—¶çš„å€¼ã€‚  

- race()

`race`æ–¹æ³•å’ŒÂ `all`ä¸€æ ·ï¼Œæ¥å—çš„å‚æ•°æ˜¯ä¸€ä¸ªæ¯é¡¹éƒ½æ˜¯Â `promise`çš„æ•°ç»„ï¼Œä½†æ˜¯ä¸Â `all`ä¸åŒçš„æ˜¯ï¼Œå½“æœ€å…ˆæ‰§è¡Œå®Œçš„äº‹ä»¶æ‰§è¡Œå®Œä¹‹åï¼Œå°±ç›´æ¥è¿”å›è¯¥Â `promise`å¯¹è±¡çš„å€¼ã€‚å¦‚æœç¬¬ä¸€ä¸ªÂ `promise`å¯¹è±¡çŠ¶æ€å˜æˆÂ `resolved`ï¼Œé‚£è‡ªèº«çš„çŠ¶æ€å˜æˆäº†Â `resolved`ï¼›åä¹‹ç¬¬ä¸€ä¸ªÂ `promise`å˜æˆÂ `rejected`ï¼Œé‚£è‡ªèº«çŠ¶æ€å°±ä¼šå˜æˆÂ `rejected`ã€‚

``` js
let promise1 = new Promise((resolve,reject)=>{
    setTimeout(()=>{
       reject(1);
    },2000)
});
let promise2 = new Promise((resolve,reject)=>{
    setTimeout(()=>{
       resolve(2);
    },1000)
});
let promise3 = new Promise((resolve,reject)=>{
    setTimeout(()=>{
       resolve(3);
    },3000)
});
Promise.race([promise1,promise2,promise3]).then(res=>{
    console.log(res);
    //ç»“æœï¼š2
},rej=>{
    console.log(rej)};
)
```

é‚£ä¹ˆÂ `race`æ–¹æ³•æœ‰ä»€ä¹ˆå®é™…ä½œç”¨å‘¢ï¼Ÿå½“è¦åšä¸€ä»¶äº‹ï¼Œè¶…è¿‡å¤šé•¿æ—¶é—´å°±ä¸åšäº†ï¼Œå¯ä»¥ç”¨è¿™ä¸ªæ–¹æ³•æ¥è§£å†³ï¼š

``` js
Promise.race([promise1,timeOutPromise(5000)]).then(res=>{})
```

- finally()

`finally`æ–¹æ³•ç”¨äºæŒ‡å®šä¸ç®¡ Promise å¯¹è±¡æœ€åçŠ¶æ€å¦‚ä½•ï¼Œéƒ½ä¼šæ‰§è¡Œçš„æ“ä½œã€‚è¯¥æ–¹æ³•æ˜¯ ES2018 å¼•å…¥æ ‡å‡†çš„ã€‚

``` js
promise
.then(result => {Â·Â·Â·})
.catch(error => {Â·Â·Â·})
.finally(() => {Â·Â·Â·});
```

ä¸Šé¢ä»£ç ä¸­ï¼Œä¸ç®¡Â `promise`æœ€åçš„çŠ¶æ€ï¼Œåœ¨æ‰§è¡Œå®ŒÂ `then`æˆ–Â `catch`æŒ‡å®šçš„å›è°ƒå‡½æ•°ä»¥åï¼Œéƒ½ä¼šæ‰§è¡ŒÂ `finally`æ–¹æ³•æŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚  

ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼ŒæœåŠ¡å™¨ä½¿ç”¨ Promise å¤„ç†è¯·æ±‚ï¼Œç„¶åä½¿ç”¨Â `finally`æ–¹æ³•å…³æ‰æœåŠ¡å™¨ã€‚

``` js
server.listen(port)
  .then(function () {
    // ...
  })
  .finally(server.stop);
```

`finally`æ–¹æ³•çš„å›è°ƒå‡½æ•°ä¸æ¥å—ä»»ä½•å‚æ•°ï¼Œè¿™æ„å‘³ç€æ²¡æœ‰åŠæ³•çŸ¥é“ï¼Œå‰é¢çš„ Promise çŠ¶æ€åˆ°åº•æ˜¯Â `fulfilled`è¿˜æ˜¯Â `rejected`ã€‚è¿™è¡¨æ˜ï¼Œ`finally`æ–¹æ³•é‡Œé¢çš„æ“ä½œï¼Œåº”è¯¥æ˜¯ä¸çŠ¶æ€æ— å…³çš„ï¼Œä¸ä¾èµ–äº Promise çš„æ‰§è¡Œç»“æœã€‚`finally`æœ¬è´¨ä¸Šæ˜¯Â `then`æ–¹æ³•çš„ç‰¹ä¾‹ï¼š

``` js
promise
.finally(() => {
  // è¯­å¥
});
// ç­‰åŒäº
promise
.then(
  result => {
    // è¯­å¥
    return result;
  },
  error => {
    // è¯­å¥
    throw error;
  }
);
```

ä¸Šé¢ä»£ç ä¸­ï¼Œå¦‚æœä¸ä½¿ç”¨Â `finally`æ–¹æ³•ï¼ŒåŒæ ·çš„è¯­å¥éœ€è¦ä¸ºæˆåŠŸå’Œå¤±è´¥ä¸¤ç§æƒ…å†µå„å†™ä¸€æ¬¡ã€‚æœ‰äº†Â `finally`æ–¹æ³•ï¼Œåˆ™åªéœ€è¦å†™ä¸€æ¬¡ã€‚  

### 5. Promiseè§£å†³äº†ä»€ä¹ˆé—®é¢˜

åœ¨å·¥ä½œä¸­ç»å¸¸ä¼šç¢°åˆ°è¿™æ ·ä¸€ä¸ªéœ€æ±‚ï¼Œæ¯”å¦‚æˆ‘ä½¿ç”¨ajaxå‘ä¸€ä¸ªAè¯·æ±‚åï¼ŒæˆåŠŸåæ‹¿åˆ°æ•°æ®ï¼Œéœ€è¦æŠŠæ•°æ®ä¼ ç»™Bè¯·æ±‚ï¼›é‚£ä¹ˆéœ€è¦å¦‚ä¸‹ç¼–å†™ä»£ç ï¼š

``` js
let fs = require('fs')
fs.readFile('./a.txt','utf8',function(err,data){
  fs.readFile(data,'utf8',function(err,data){
    fs.readFile(data,'utf8',function(err,data){
      console.log(data)
    })
  })
})
```

ä¸Šé¢çš„ä»£ç æœ‰å¦‚ä¸‹ç¼ºç‚¹ï¼š  

- åä¸€ä¸ªè¯·æ±‚éœ€è¦ä¾èµ–äºå‰ä¸€ä¸ªè¯·æ±‚æˆåŠŸåï¼Œå°†æ•°æ®å¾€ä¸‹ä¼ é€’ï¼Œä¼šå¯¼è‡´å¤šä¸ªajaxè¯·æ±‚åµŒå¥—çš„æƒ…å†µï¼Œä»£ç ä¸å¤Ÿç›´è§‚ã€‚
- å¦‚æœå‰åä¸¤ä¸ªè¯·æ±‚ä¸éœ€è¦ä¼ é€’å‚æ•°çš„æƒ…å†µä¸‹ï¼Œé‚£ä¹ˆåä¸€ä¸ªè¯·æ±‚ä¹Ÿéœ€è¦å‰ä¸€ä¸ªè¯·æ±‚æˆåŠŸåå†æ‰§è¡Œä¸‹ä¸€æ­¥æ“ä½œï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œé‚£ä¹ˆä¹Ÿéœ€è¦å¦‚ä¸Šç¼–å†™ä»£ç ï¼Œå¯¼è‡´ä»£ç ä¸å¤Ÿç›´è§‚ã€‚

`Promise`å‡ºç°ä¹‹åï¼Œä»£ç å˜æˆè¿™æ ·ï¼š

``` js
let fs = require('fs')
function read(url){
  return new Promise((resolve,reject)=>{
    fs.readFile(url,'utf8',function(error,data){
      error && reject(error)
      resolve(data)
    })
  })
}
read('./a.txt').then(data=>{
  return read(data) 
}).then(data=>{
  return read(data)  
}).then(data=>{
  console.log(data)
})
```

è¿™æ ·ä»£ç çœ‹èµ·äº†å°±ç®€æ´äº†å¾ˆå¤šï¼Œè§£å†³äº†åœ°ç‹±å›è°ƒçš„é—®é¢˜ã€‚  
